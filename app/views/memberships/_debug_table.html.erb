  <%
    @stats = MembershipStats.new(business: @business,
                                 year: params[:year].to_i, month: params[:month].to_i,
                                 membership_filter: @membership_filter)
  %>

<h1>Debug <%= l(debug_date = Date.civil(params[:year].to_i,params[:month].to_i,1), format: :month) %></h1>
<h2>Proyección installments</h2>
<table class="table table-striped table-hover table-condensed table-bordered">
  <thead>
    <tr>
      <th> id </th>
      <th> contact </th>
      <th> instuctor </th>
      <th> nombre membresia </th>
      <th> periodo </th>
      <th> suma installments </th>
      <th> valor membresia </th>
    </tr>
  </thead>

  <tbody>
<% @stats.is_scope.includes(:contact, installments: :agent).order("contacts.name").each do |m| %>
  <tr>
    <td>
      <%= m.id %>
    </td>
    <td>
      <%= m.contact.name %>
    </td>
    <td>
      <%= installment_for(debug_date,m.installments).agent.name %>
    </td>
    <td>
      <%= m.name %>
    </td>
    <td>
      <%= m.begins_on %> - <%= m.ends_on %>
    </td>
    <td>
      <%= @stats.is_scope.where(id: m.id).sum("installments.value") %>
    </td>
    <td>
      <%= m.value %>
    </td>
  </tr>
<% end %>
  </tbody>
</table>

<h2>Proyección membresias sin installment</h2>
<table class="table table-striped table-hover table-condensed table-bordered">
  <thead>
    <tr>
      <th> id </th>
      <th> contact </th>
      <th> instuctor </th>
      <th> nombre membresia </th>
      <th> periodo </th>
      <th></th>
      <th> valor membresia </th>
    </tr>
  </thead>
  <tbody>
<% @stats.ms_scope.includes(:contact).order("contacts.name").each do |m| %>
  <tr>
    <td>
      <%= m.id %>
    </td>
    <td>
      <%= m.contact.name %>
    </td>
    <td>
      <%= m.contact.padma_teacher %>
    </td>
    <td>
      <%= m.name %>
    </td>
    <td>
      <%= m.begins_on %> - <%= m.ends_on %>
    </td>
    <td>
    </td>
    <td>
      <%= m.value %>
    </td>
  </tr>
<% end %>
  </tbody>
</table>

<h2>Installments pagos</h2>
<table class="table table-striped table-hover table-condensed table-bordered">
  <thead>
    <tr>
      <th> id </th>
      <th> contact </th>
      <th> instuctor </th>
      <th> nombre membresia </th>
      <th> periodo </th>
      <th></th>
      <th> valor membresia </th>
    </tr>
  </thead>
  <tbody>
<% @stats.paid_installments_scope.joins(:contact).order("contacts.name").each do |m| %>
  <tr>
    <td>
      <%= m.id %>
    </td>
    <td>
      <%= m.contact.name %>
    </td>
    <td>
      <%= %>
    </td>
    <td>
      <%= m.name %>
    </td>
    <td>
      <%= m.begins_on %> - <%= m.ends_on %>
    </td>
    <td>
      <%= @stats.paid_installments_scope.where(id: m.id).select("SUM(CASE WHEN ((installments.status IS NULL) OR installments.status = 'overdue' OR installments.status = 'incomplete') AND installments.balance < installments.value THEN installments.balance ELSE installments.value END) AS sum, AVG(CASE WHEN ((installments.status IS NULL) OR installments.status = 'overdue' OR installments.status = 'incomplete') AND installments.balance < installments.value THEN installments.balance ELSE installments.value END) AS avg").first["sum"] %>
    </td>
    <td>
      <%= m.value %>
    </td>
  </tr>
<% end %>
  </tbody>
</table>
